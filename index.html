<!DOCTYPE html>
<html>
<body onload='init()'>

<div id='container' style="margin:auto;">
    <div id='clouds'></div>
</div>

<style>
    body {
        margin: 0;
    }
    #container {
        position: relative;
    }
    #container > * {
        position: absolute;
        left: 0;
    }

    #tree-canvas {
        z-index: -2
    }

    #clouds {
        background: linear-gradient(0deg, rgba(255,255,255,.2) 0%, rgba(0,0,0,.8) 100%);
        z-index: -1;
        width:100%;
        height:100%;
    }

</style>

<script>

function cos(A) {
    return Math.cos(-Math.PI*(A/180));
}

function sin(A) {
    return Math.sin(-Math.PI*(A/180));
}

function getAngle(curA, deviation) {
    return (curA + Math.random()*(deviation*2)) - deviation;
}

function drawLightningSegment(lightning_jar, x, y, A) {

    const new_jar = {
        branches: 1,
        unit: Math.random() * 7 + 8,
        strokes: [],
        created: new Date()
    };
    lightning_jar.push(new_jar);

    _drawLightningSegment(new_jar, x, y, A, 0);
}

function delayFn(fn, delay) {
    return (...props)=> setTimeout(()=> { 
            fn(...props)
        }, delay);
}

function getContext(id) {
    canvas = document.getElementById(id);
    if (!canvas) {
        canvas = document.createElement('canvas');
        canvas.width = WIDTH;
        canvas.height = HEIGHT;
        canvas.id = id;
        document.getElementById('container').appendChild(canvas)
    }
    return canvas.getContext("2d");
}

function _drawLightningSegment(jar, x, y, A, distance_from_arc) {
    if(x < 0 || x > WIDTH || y < 0 || y > HEIGHT) {
        --jar.branches;
        return 
    }
    const context = getContext('lightning-canvas');

    ++jar.branches;

    const nX = x + jar.unit * cos(A);
    const nY = y - jar.unit * sin(A);


    const ratio = (3 * (canvas.height-nY) /* */) / canvas.height;
    const splitPct = ratio * .1 / (distance_from_arc + 1); // As distance from main arc increases, chance to split decreases
    const straightPct = ratio * .6 / (distance_from_arc + 1);
    const deviatePct = ratio * .9 / (distance_from_arc + 1);

    jar.strokes.push({x: x, nx: nX, y: y, ny: nY, distance_from_arc: distance_from_arc, created: new Date()})
    
    let n = Math.random();

    if (n <= splitPct) { 
        _drawLightningSegment(jar, nX, nY, (A - Math.random() * 15), distance_from_arc + 1);
        _drawLightningSegment(jar, nX, nY, (A + Math.random() * 15), distance_from_arc + 1);
    } 
    n = Math.random();

    if (n <= deviatePct) { 
        _drawLightningSegment(jar, nX, nY, getAngle(A, 15), distance_from_arc);
    }  
    --jar.num_branches;
    return;
}

_drawLightningSegment = delayFn(_drawLightningSegment, 20)

function draw(x,y,A) {
    if(x < 0 || x > WIDTH || y < 0 || y > HEIGHT) {
        return 
    }
    num_branches++;

    setTimeout(()=> {
        _draw(x,y,A);
    }, 30);
}

function _draw(x,y,A) {
    let nX = x + UNIT * cos(A);
    let nY = y + UNIT * sin(A);

    context = getContext('tree-canvas')
    context.beginPath();
    context.moveTo(x,y);
    context.lineTo(nX,nY);
    context.stroke();

    if(( Math.sinh(Math.abs(initialX - nX)/WIDTH ) + (initialY + 50 - nY)/HEIGHT ) >= 1 ) {
        num_branches--;
        return;
    }
    
    let n = Math.random();
    
    let ratio = 1.7*(nY)/700;
    let angle_ratio = (90 - Math.abs(90 - A)) / 90;
    let straightPct = ratio * .6 * angle_ratio
    let deviatePct = ratio * .8 * angle_ratio
    let splitPct = ratio * .9 * angle_ratio

    if(n <= straightPct) {
        n = Math.random();
        if(n <= .1) {
            draw(nX, nY, getAngle(A, 15));
        }
        draw(nX, nY, A);
    } else if(n <= deviatePct) { 
        draw(nX, nY, getAngle(A, 15));
    } else if(n <= splitPct) { 
        if(Math.random() > .5) {
            draw(nX, nY, (A + Math.random()*15));
            draw(nX, nY, (A - Math.random()*15));
        } else {
            draw(nX, nY, (A - Math.random()*15));
            draw(nX, nY, (A + Math.random()*15));
        }
    }
    num_branches--;
    return;
}

function clear(context) {
    context.clearRect(0,0,WIDTH,HEIGHT);

    const gradiant = context.createLinearGradient(0, WIDTH/2, 0, HEIGHT/2);
    gradiant.addColorStop(0, "black");
    gradiant.addColorStop(1, "white");

    // Fill with gradient
    context.fillStyle = gradiant;
}

function Tree() {
    return new Promise( (res, _)=> {
        draw(initialX, initialY, 90,0,0);

        (function waitForCompletion() {
            if (!num_branches) return setTimeout(()=> res(null), 1500);
            setTimeout(waitForCompletion, 30);
        })();
    });
}

let WIDTH;
let HEIGHT;
let UNIT;

let initialX;
let initialY;
let num_branches = 0;
function init() {
    WIDTH = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
    HEIGHT = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
    initialX = WIDTH/2;
    initialY = HEIGHT-20;
    UNIT = 15;
    const container  = document.getElementById("container");
    container.style.height = HEIGHT+'px';
    container.style.width = WIDTH+'px';

    const tree_context = getContext('tree-canvas');

    let zen = 0;

    let lightning_jar = [];
    (async ()=> {
        while(1) {
            clear(tree_context);
            await Tree();
            console.log(`Tree${zen?'s':''}: ${++zen}`);
        }
    })();

    (tryLightning = delayFn(() =>  {
        if (Math.random() < .015) {
            let maybeNegativeX = 1;
            if (Math.random() > .5) maybeNegativeX *= -1;
            const x_modifier = Math.random() * initialX * maybeNegativeX;

            let maybeNegativeAngle = 1;
            if (Math.random() > .5) maybeNegativeAngle *= -1;
            
            drawLightningSegment(lightning_jar, initialX + x_modifier, 0, 90 + maybeNegativeX * Math.random() * 15);
        }
        tryLightning()
    }, 30))();


    const lightningAge = 1*1000; 
    (slowClearLightning = delayFn(() =>  {
        const context = getContext('lightning-canvas');
        context.clearRect(0, 0, WIDTH, HEIGHT);
        lightning_jar = lightning_jar.filter((jar, index) => {
            // Delete lightning jar if no segments remain
            if (!jar.strokes.length) {
                return false;
            }
            jar.strokes = jar.strokes.filter(stroke => {
                // Delete if last lightning segment is older than maximum age
                if (stroke.created < new Date() - lightningAge) {
                    return false;
                }
                
                context.strokeStyle = `rgb(${170 + (75 * ( 1 / (stroke.distance_from_arc + 1)))}, ${170 + (75 * ( 1 / (stroke.distance_from_arc + 1)))}, 255, ${1 - ((new Date() - stroke.created) / (lightningAge))}`;
                context.beginPath();
                context.moveTo(stroke.x, stroke.y);
                context.lineTo(stroke.nx, stroke.ny);
                context.lineWidth = 3 * (1 / (stroke.distance_from_arc + 1));

                context.stroke();
                return true;
            });
            return true;
        });
        slowClearLightning()
    }, 30))();
}


</script>

</body>
</html>

